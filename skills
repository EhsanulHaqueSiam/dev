#!/usr/bin/env bash
set -euo pipefail

# Manage Claude Code skills — list, search, install, remove
# Usage: dev skills <command> [args...]

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
LIBRARY="$SCRIPT_DIR/skills-lib"

show_help() {
	cat <<-'EOF'
	Usage: dev skills <command> [args...]

	Commands:
	  fetch                        Download all skills from GitHub
	  update                       Re-fetch all skills (alias for fetch)
	  list                         List available skills
	  search <term>                Filter skills by keyword
	  install <name> [<name>...]   Install skill(s) into current project
	  remove <name>                Remove skill from current project
	  installed                    Show skills in current project

	Skills are installed to .claude/skills/<name>/ in the current directory.
	EOF
}

# Read description from SKILL.md frontmatter (description: line)
# Handles both inline and YAML multi-line (> or |) descriptions
get_description() {
	local skill_md="$1/SKILL.md"
	[[ -f "$skill_md" ]] || return 0
	local in_front=0 val=""
	while IFS= read -r line; do
		if [[ "$in_front" -eq 0 ]]; then
			[[ "$line" == "---" ]] && in_front=1
			continue
		fi
		[[ "$line" == "---" ]] && break
		if [[ "$line" =~ ^description: ]]; then
			val="${line#description:}"
			val="${val#"${val%%[![:space:]]*}"}"  # trim leading whitespace
			val="${val#\"}" ; val="${val%\"}"
			val="${val#\'}" ; val="${val%\'}"
			# If value is > or | or empty, read next indented line
			if [[ -z "$val" || "$val" == ">" || "$val" == "|" ]]; then
				val=""
				while IFS= read -r nextline; do
					if [[ "$nextline" =~ ^[[:space:]]+ ]]; then
						local trimmed="${nextline#"${nextline%%[![:space:]]*}"}"
						if [[ -z "$val" ]]; then
							val="$trimmed"
						else
							val="$val $trimmed"
						fi
					else
						break
					fi
				done
			fi
			break
		fi
	done < "$skill_md"
	echo "$val"
}

# Read provider from .source file
get_provider() {
	local source_file="$1/.source"
	if [[ -f "$source_file" ]]; then
		cat "$source_file"
	else
		echo "unknown"
	fi
}

# Map repo to short provider label
provider_label() {
	local repo="$1"
	case "$repo" in
		anthropics/*)            echo "anthropic" ;;
		vercel-labs/*)           echo "vercel" ;;
		cloudflare/*)            echo "cloudflare" ;;
		supabase/*)              echo "supabase" ;;
		google-labs-code/*)      echo "google" ;;
		huggingface/*)           echo "huggingface" ;;
		stripe/*)                echo "stripe" ;;
		callstackincubator/*)    echo "callstack" ;;
		expo/*)                  echo "expo" ;;
		better-auth/*)           echo "better-auth" ;;
		neondatabase/*)          echo "neon" ;;
		dmmulroy/*)              echo "dmmulroy" ;;
		hashicorp/*)             echo "hashicorp" ;;
		sanity-io/*)             echo "sanity" ;;
		remotion-dev/*)          echo "remotion" ;;
		WordPress/*)             echo "wordpress" ;;
		openai/*)                echo "openai" ;;
		ComposioHQ/*)            echo "composio" ;;
		obra/*)                  echo "obra" ;;
		coreyhaines31/*)         echo "coreyhaines" ;;
		BrianRWagner/*)          echo "brianwagner" ;;
		AgriciDaniel/*)          echo "agricidaniel" ;;
		wshuyi/*)                echo "wshuyi" ;;
		jthack/*)                echo "jthack" ;;
		lackeyjb/*)              echo "lackeyjb" ;;
		K-Dense-AI/*)            echo "k-dense-ai" ;;
		Orchestra-Research/*)    echo "orchestra" ;;
		*)                       echo "${repo%%/*}" ;;
	esac
}

cmd_fetch() {
	exec "$SCRIPT_DIR/skills-fetch" "$@"
}

cmd_list() {
	if [[ ! -d "$LIBRARY" ]]; then
		echo "No skills found. Run 'dev skills fetch' first."
		exit 1
	fi

	# Collect skills grouped by provider
	declare -A groups
	local count=0
	for dir in "$LIBRARY"/*/; do
		[[ -d "$dir" ]] || continue
		local name repo label
		name="$(basename "$dir")"
		repo="$(get_provider "$dir")"
		label="$(provider_label "$repo")"
		groups["$label"]+="$name"$'\n'
		((count++)) || true
	done

	# Sort providers and print
	local sorted_providers
	sorted_providers=$(printf '%s\n' "${!groups[@]}" | sort)
	while IFS= read -r provider; do
		[[ -z "$provider" ]] && continue
		printf "\n  \033[1m%s\033[0m\n" "$provider"
		while IFS= read -r name; do
			[[ -z "$name" ]] && continue
			local desc
			desc="$(get_description "$LIBRARY/$name")"
			if [[ -n "$desc" ]]; then
				# Truncate long descriptions
				[[ ${#desc} -gt 70 ]] && desc="${desc:0:67}..."
				printf "    %-35s %s\n" "$name" "$desc"
			else
				printf "    %s\n" "$name"
			fi
		done <<< "${groups[$provider]}"
	done <<< "$sorted_providers"

	printf "\n%d skills available\n" "$count"
}

cmd_search() {
	local term="$1"
	if [[ ! -d "$LIBRARY" ]]; then
		echo "No skills found. Run 'dev skills fetch' first."
		exit 1
	fi
	local found=0
	for dir in "$LIBRARY"/*/; do
		[[ -d "$dir" ]] || continue
		local name repo label desc
		name="$(basename "$dir")"
		repo="$(get_provider "$dir")"
		label="$(provider_label "$repo")"
		desc="$(get_description "$dir")"
		local haystack="$name $label $desc"
		if echo "$haystack" | grep -qFi "$term"; then
			if [[ -n "$desc" ]]; then
				[[ ${#desc} -gt 60 ]] && desc="${desc:0:57}..."
				printf "  %-15s %-30s %s\n" "$label" "$name" "$desc"
			else
				printf "  %-15s %s\n" "$label" "$name"
			fi
			((found++)) || true
		fi
	done
	if [[ "$found" -eq 0 ]]; then
		echo "No skills matching '$term'"
	else
		printf "\n%d match(es)\n" "$found"
	fi
}

cmd_install() {
	if [[ $# -eq 0 ]]; then
		echo "Usage: dev skills install <name> [<name>...]"
		exit 1
	fi
	local target=".claude/skills"
	for name in "$@"; do
		local src="$LIBRARY/$name"
		if [[ ! -d "$src" || ! -f "$src/SKILL.md" ]]; then
			echo "✗ skill '$name' not found in library"
			continue
		fi
		mkdir -p "$target/$name"
		cp -r "$src"/. "$target/$name/"
		echo "✓ installed $name → $target/$name/"
	done
}

cmd_remove() {
	if [[ $# -eq 0 ]]; then
		echo "Usage: dev skills remove <name>"
		exit 1
	fi
	local name="$1"
	local target=".claude/skills/$name"
	if [[ ! -d "$target" ]]; then
		echo "✗ skill '$name' not installed in this project"
		exit 1
	fi
	rm -rf "$target"
	echo "✓ removed $name"
}

cmd_installed() {
	local target=".claude/skills"
	if [[ ! -d "$target" ]]; then
		echo "No skills installed in this project."
		return
	fi
	local count=0
	for dir in "$target"/*/; do
		[[ -d "$dir" ]] || continue
		local name
		name="$(basename "$dir")"
		local desc
		desc="$(get_description "$dir")"
		if [[ -n "$desc" ]]; then
			printf "  %-40s %s\n" "$name" "$desc"
		else
			printf "  %s\n" "$name"
		fi
		((count++)) || true
	done
	if [[ "$count" -eq 0 ]]; then
		echo "No skills installed in this project."
	else
		printf "\n%d skill(s) installed\n" "$count"
	fi
}

case "${1:---help}" in
	fetch|update) shift; cmd_fetch "$@" ;;
	list)         cmd_list ;;
	search)
		shift
		if [[ $# -eq 0 ]]; then
			echo "Usage: dev skills search <term>"
			exit 1
		fi
		cmd_search "$1"
		;;
	install)      shift; cmd_install "$@" ;;
	remove)       shift; cmd_remove "$@" ;;
	installed)    cmd_installed ;;
	-h|--help)    show_help ;;
	*)
		echo "Unknown command: $1"
		echo "Run 'dev skills --help' for usage."
		exit 1
		;;
esac