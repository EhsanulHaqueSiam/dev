#!/usr/bin/env bash
set -uo pipefail

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" &>/dev/null && pwd)"

# Auto-detect DEV_ENV from script location if not set
if [ -z "${DEV_ENV:-}" ]; then
	DEV_ENV="$script_dir"
fi
export DEV_ENV="$DEV_ENV"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

grep_filter=""
dry_run="0"
env_only="0"

while [[ $# -gt 0 ]]; do
	case "$1" in
		--dry)  dry_run="1" ;;
		--env)  env_only="1" ;;
		*)      grep_filter="$1" ;;
	esac
	shift
done

log()  { echo -e "${GREEN}[run]${NC} $1"; }
warn() { echo -e "${YELLOW}[run]${NC} $1"; }
err()  { echo -e "${RED}[run]${NC} $1"; }
info() { echo -e "${BLUE}[run]${NC} $1"; }

passed=()
failed=()
skipped=()

# -----------------------------------------------------------------------
# Auto-install paru (AUR helper) if missing — most installers need it
# -----------------------------------------------------------------------
if [[ $env_only == "0" && $dry_run == "0" ]] && ! command -v paru &>/dev/null; then
	warn "paru not found — installing (required by most tool scripts)..."
	sudo pacman -S --needed --noconfirm base-devel git
	tmpdir=$(mktemp -d)
	git clone https://aur.archlinux.org/paru.git "$tmpdir/paru"
	(cd "$tmpdir/paru" && makepkg -si --noconfirm)
	rm -rf "$tmpdir"
	if command -v paru &>/dev/null; then
		log "paru installed successfully"
	else
		err "paru installation failed — some tools may not install"
	fi
	echo ""
fi

# -----------------------------------------------------------------------
# Run installers (unless --env flag to only deploy configs)
# -----------------------------------------------------------------------
if [[ $env_only == "0" ]]; then
	log "running installers..."
	echo ""

	runs_dir=$(find "$script_dir/runs" -mindepth 1 -maxdepth 1 -executable | sort)

	for s in $runs_dir; do
		name=$(basename "$s")

		if [[ -n "$grep_filter" ]] && ! echo "$name" | grep -q "$grep_filter"; then
			skipped+=("$name")
			continue
		fi

		info "--- $name ---"

		if [[ $dry_run == "1" ]]; then
			warn "[DRY_RUN] would run: $s"
			skipped+=("$name")
		else
			if "$s"; then
				passed+=("$name")
			else
				err "failed: $name"
				failed+=("$name")
			fi
		fi
		echo ""
	done
fi

# -----------------------------------------------------------------------
# Deploy configs (always runs unless grep filters it out)
# -----------------------------------------------------------------------
if [[ -z "$grep_filter" ]] || [[ "env" == *"$grep_filter"* ]] || [[ $env_only == "1" ]]; then
	log "deploying configs..."
	if [[ $dry_run == "1" ]]; then
		"$script_dir/dev-env" --dry
	else
		if "$script_dir/dev-env"; then
			passed+=("dev-env")
		else
			err "failed: dev-env"
			failed+=("dev-env")
		fi
	fi
	echo ""
fi

# -----------------------------------------------------------------------
# Summary
# -----------------------------------------------------------------------
echo ""
echo -e "${GREEN}================================${NC}"
log "summary"
echo -e "${GREEN}================================${NC}"

if [[ ${#passed[@]} -gt 0 ]]; then
	log "passed (${#passed[@]}): ${passed[*]}"
fi
if [[ ${#skipped[@]} -gt 0 ]]; then
	warn "skipped (${#skipped[@]}): ${skipped[*]}"
fi
if [[ ${#failed[@]} -gt 0 ]]; then
	err "FAILED (${#failed[@]}): ${failed[*]}"
	exit 1
fi

log "all done!"
